<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>jsonp</title>
</head>
<body>
<script>
const utils = {
  /**
   * 页面中注入js脚本
   * @param {String} url - js请求地址
   * @param {String} charset - 字符集
   */
  createScript(url, charset) {
    const script = document.createElement('script')
    script.setAttribute('type', 'text/javascript')
    charset && script.setAttribute('charset', charset)
    script.setAttribute('src', url)
    script.async = true

    return script
  },
  /**
   *  获取一个随机的5位字符串(toString(36)是什么?)
   * @param {String} prefix - 前缀
   */
  getName(prefix) {
    const random = Math.random().toString(36).replace(/[^a-z]+)/g, '').substr(0, 5)
    return `${prefix}${random}`
  },
  /**
   * 判断是否是一个函数
   * @param {function} source - 函数名称
   * @returns {Boolean} 是否是函数布尔值
   */
  isFunction() {
    return '[object Function]' === Object.prototype.toString.call(source)
  }
}

/**
 * jsonp方法
 */
function jsonp(url, onsuccess, onerror, charset) {
  const callbackName = utils.getName('tt_player')
  const script = utils.createScript(`${url}&callback=${callbackName}`, charset)
  
  window[callbackName] = function() {
    if (onsuccess && utils.isFunction(onsuccess)) {
      onsuccess(arguments[0])
    }
  }

  script.onload = script.onreadystatechange = function () {
    if (!script.readyState || /load|complete/.test(script.readyState)) {
      script.onload = script.onreadystatechange = null
      // 移除该script的DOM对象
      if (script.parentNode) {
        script.parentNode.removeChild(script)
      }
      // 删除函数或变量
      window[callbackName] = null
    }
  }

  script.onerror = function() {
    if (onerror && utils.isFunction(onerror)) {
      onerror()
    }
  }

  document.getElementsByTagName('head')[0].appendChild(script)
}

</script>
<a href="https://zhangguixu.github.io/2016/12/02/jsonp/">jsonp的原理与实现</a>
</body>
</html>